- type: htnCompound
  id: STCatCompound
  branches:
    - tasks:
      - !type:HTNCompoundTask
        task: STCatMeleeCombatCompound
    - tasks:
      - !type:HTNCompoundTask
        task: STCatRoarRestoreCompound
      - !type:HTNCompoundTask
        task: IdleSpinCompound

- type: htnCompound
  id: STCatMeleeCombatCompound
  branches:
  # Move to melee range and hit them
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:UtilityOperator
        proto: NearbyMeleeTargets
    - !type:HTNCompoundTask
      task: STCatRoarCompound
    - !type:HTNCompoundTask
      task: STCatMeleeAttackTargetCompound

- type: htnCompound
  id: STCatRoarRestoreCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      preconditions:
      - !type:KeyBoolEqualsPrecondition
        key: Roared
        value: true
      operator: !type:SetBoolOperator
        targetKey: Roared
        value: false

- type: htnCompound
  id: STCatRoarCompound
  branches:
  - tasks:
    - !type:HTNPrimitiveTask
      operator: !type:PlaySoundOperator
        sound:
          collection: CatAttack
          params:
            variation: 0.125

    - !type:HTNPrimitiveTask
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: RangedRange

    - !type:HTNPrimitiveTask
      operator: !type:JukeOperator
        jukeType: AdjacentTile

    - !type:HTNPrimitiveTask
      operator: !type:SetFloatOperator
        targetKey: AttackDelay
        amount: 0.8

    - !type:HTNPrimitiveTask
      operator: !type:WaitOperator
        key: AttackDelay
      preconditions:
      - !type:KeyExistsPrecondition
        key: AttackDelay

    - !type:HTNPrimitiveTask
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: RangedRange

    - !type:HTNPrimitiveTask
      operator: !type:JukeOperator
        jukeType: AdjacentTile

    - !type:HTNPrimitiveTask
      operator: !type:SetFloatOperator
        targetKey: AttackDelay
        amount: 0.8

    - !type:HTNPrimitiveTask
      operator: !type:WaitOperator
        key: AttackDelay
      preconditions:
      - !type:KeyExistsPrecondition
        key: AttackDelay

    - !type:HTNPrimitiveTask
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: RangedRange

    - !type:HTNPrimitiveTask
      operator: !type:JukeOperator
        jukeType: AdjacentTile

    - !type:HTNPrimitiveTask
      operator: !type:SetFloatOperator
        targetKey: AttackDelay
        amount: 0.8

    - !type:HTNPrimitiveTask
      operator: !type:WaitOperator
        key: AttackDelay
      preconditions:
      - !type:KeyExistsPrecondition
        key: AttackDelay

    # - !type:HTNPrimitiveTask
      # preconditions:
      # - !type:KeyBoolEqualsPrecondition
        # key: Roared
        # value: false
      # operator: !type:PlaySoundOperator
        # sound:
          # collection: HumanSounds # Stalker-TODO: Uncomment these once "HumanSounds" sound collection exists!
          # params:
            # variation: 0.125
            # maxDistance: 100

    - !type:HTNPrimitiveTask
      operator: !type:SetBoolOperator
        targetKey: Roared
        value: true

- type: htnCompound
  id: STCatMeleeAttackTargetCompound
  branches:
  # Move to melee range and hit them
  - tasks:
    - !type:HTNPrimitiveTask
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      operator: !type:MoveToOperator
        shutdownState: PlanFinished
        pathfindInPlanning: true
        removeKeyOnFinish: false
        targetKey: TargetCoordinates
        pathfindKey: TargetPathfind
        rangeKey: MeleeRange
    - !type:HTNPrimitiveTask
      operator: !type:JukeOperator
        jukeType: AdjacentTile
    - !type:HTNPrimitiveTask
      operator: !type:MeleeOperator
        targetKey: Target
      preconditions:
      - !type:KeyExistsPrecondition
        key: Target
      - !type:TargetInRangePrecondition
        targetKey: Target
        rangeKey: MeleeRange
      services:
      - !type:UtilityService
        id: MeleeService
        proto: NearbyMeleeTargets
        key: Target
